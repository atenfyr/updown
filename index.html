<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>Up-Down</title>

        <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>        
        <style>
            noscript {
                font-size: 20px;
            }

            h1 {
                font-size: 110px;
            }

            #lastmove {
                font-size: 75px;
            }

            #wrapper {
                font-size: 50px;
            }

            * {
                margin: 0;
                padding: 0;
            }

            #wrapper {
                margin: 0;
                padding: 0;

                color: black;
                font-family: Open Sans, Arial, sans-serif;
                text-align: center;
            }
        </style>
        <script>
            var upCount = -1;
            var downCount = 0;
            var score = 0;
            var autoLoseTimer;

            var isDisabled = false;

            document.onkeydown = function(e) {
                if (isDisabled) {
                    return;
                }

                if (upCount === -1 && (e.keyCode === 38 || e.keyCode === 87 || e.keyCode === 40 || e.keyCode === 83)) {
                    updateScore(0);
                }

                e = e || window.event;
                switch(e.keyCode) {
                    case 38: // up arrow
                    case 87: // w
                        document.getElementById('instructions').style = 'display: none;';
                        document.getElementById('lastmove').style = '';

                        if (document.getElementById('lastmove').innerHTML.length >= 20) {
                            document.getElementById('lastmove').innerHTML = '↑';
                        } else {
                            document.getElementById('lastmove').innerHTML += '↑';
                        }

                        if (upCount !== -1 && upCount !== -2 && (++upCount > 2 || downCount !== 2)) {
                            endGame();
                        }
                        if (upCount === -1) {
                            upCount = -2;
                        } else if (upCount === -2) {
                            upCount = 2;
                        }
                        if (upCount === 2) {
                            downCount = 0;
                        }

                        if (autoLoseTimer) {
                            clearTimeout(autoLoseTimer);
                        }
                        autoLoseTimer = setTimeout(endGame, 500);
                        break;
                    case 40: // down arrow
                    case 83: // s
                        document.getElementById('instructions').style = 'display: none;';
                        document.getElementById('lastmove').style = '';

                        if (document.getElementById('lastmove').innerHTML.length >= 20) {
                            document.getElementById('lastmove').innerHTML = '↓';
                        } else {
                            document.getElementById('lastmove').innerHTML += '↓';
                        }

                        if (++downCount > 2 || upCount !== 2) {
                            endGame();
                        }
                        if (downCount === 2) {
                            upCount = 0;
                            updateScore(++score);
                        }

                        
                        if (autoLoseTimer) {
                            clearTimeout(autoLoseTimer);
                        }
                        autoLoseTimer = setTimeout(endGame, 500);
                        break;
                }
            }

            function updateScore(val) {
                if (!isDisabled) {
                    document.getElementById('score').innerHTML = '<br>Score: ' + val;
                }
            }

            function setCookie(name, value, expiration) {
                var thisDate = new Date();
                thisDate.setTime(thisDate.getTime() + (expiration*24*60*60*1000));
                document.cookie = name + "=" + value + ";expires=" + thisDate.toUTCString() + ";path=/";
            }

            function getCookie(c_name) {
                var c_value = " " + document.cookie;
                var c_start = c_value.indexOf(" " + c_name + "=");
                if (c_start == -1) {
                    c_value = null;
                } else {
                    c_start = c_value.indexOf("=", c_start) + 1;
                    var c_end = c_value.indexOf(";", c_start);
                    if (c_end == -1) {
                        c_end = c_value.length;
                    }
                    c_value = unescape(c_value.substring(c_start,c_end));
                }
                return c_value;
            }

            function getHighscore() {
                return Number(getCookie('highscore')) || 0;
            } 

            function endGame() {
                if (!isDisabled) {
                    isDisabled = true;
                    if (score > getHighscore()) {
                        setCookie('highscore', score, 365);
                        document.getElementById('highscore').innerHTML = 'New high score!';
                    } else {
                        document.getElementById('highscore').innerHTML = 'High score: ' + getHighscore();
                    }

                    setTimeout(() => {
                        document.getElementById('highscore').style = 'display: initial;';
                        setTimeout(() => {
                            document.getElementById('refresh').style = 'display: initial;';
                        }, 800);
                    }, 400);
                }
                score = 0;
            }

            window.addEventListener("load", function() {
                document.getElementById('wrapper').style = '';

                if (getCookie('seenInstructions') !== 'yes') {
                    setCookie('seenInstructions', 'yes', 7);
                } else {
                    document.getElementById('instructions').style = 'display: none;';
                    document.getElementById('lastmove').style = '';
                }

                window.cookieconsent.initialise({
                    "palette": {
                        "popup": {
                            "background": "#efefef",
                            "text": "#404040"
                        }
                    },
                    "button": {
                        "background": "#8ec760",
                        "text": "#ffffff"
                    }
                });
            });
        </script>
    </head>
    <body>
        <noscript>
            To play this game, please enable JavaScript.
            Here are some <a href="https://www.enable-javascript.com/" target="_blank">instructions</a> on how to enable JavaScript in your web browser.
        </noscript>
        <div id='wrapper' style='display: none;'>
            <h1>Up-Down</h1>
            <span id='instructions'>Keep typing ↑↑↓↓, and don't pause!<br></span>
            <span id='lastmove' style='display: none;'></span>
            <span id='score'>Score: 0</span><br>
            <span id='highscore' style='display: none;'></span><br>
            <span id='refresh' style='display: none;'><a style='text-decoration: none; color: #0645AD;' onclick='window.location.reload();' href='#'>Try again?</a></span>
        </div>
    </body>
</html>
